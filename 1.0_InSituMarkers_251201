```{r}

seurat_obj <- readRDS("/data/matthew/250911_new/supraresults_251112_0.3res/subset_analysis_seurat.rds")
# =============================================================================
# STAGE-SPECIFIC UMAPs FOR MULTIPLE GENES - BATCH VERSION
# Shows gene expression for each timepoint group separately
# =============================================================================

library(Seurat)
library(ggplot2)
library(patchwork)

# =============================================================================
# LIST OF GENES TO ANALYZE
# =============================================================================
genes_to_analyze <- c("g17644","g20517","g15426","g18222")  # Add your genes here

# Define timepoint groups (if not already defined)
seurat_obj$timepoint_group <- case_when(
  seurat_obj$sample %in% c("C1a", "C2a", "N") ~ "C1a, C2a, N",
  seurat_obj$sample %in% c("R2", "R2X") ~ "R2, R2X",
  seurat_obj$sample %in% c("R1a","R2a", "R5") ~ "R1a, R2a, R5",
  seurat_obj$sample %in% c("R7", "R7X") ~ "R7, R7X",
  seurat_obj$sample %in% c("R10", "R10X") ~ "R10, R10X",
  TRUE ~ "Other"
)

# Define colors for each group
timepoint_colors <- c(
  "C1a, C2a, N" = "#0D4D3D",      # Dark forest green
  "R2, R2X" = "#8B0000",     # Dark red
  "R1a, R2a, R5" = "#B8860B",          # Dark goldenrod
  "R7, R7X" = "#4B0082",          # Dark indigo
  "R10, R10X" = "#00008B"         # Dark blue
)

# Get list of timepoint groups
timepoint_groups <- c("C1a, C2a, N", "R2, R2X", "R1a, R2a, R5", "R7, R7X", "R10, R10X")

# Base output directory
base_output_dir <- "/data/matthew/250911_new/results/251125_insitu_plots/"

# =============================================================================
# LOOP THROUGH EACH GENE
# =============================================================================

for (gene in genes_to_analyze) {
  
  message("\n========================================")
  message("Processing gene: ", gene)
  message("========================================\n")
  
  # Check if gene exists in the dataset
  if (!gene %in% rownames(seurat_obj)) {
    message("WARNING: Gene ", gene, " not found in dataset. Skipping...")
    next
  }
  
  # Create gene-specific output directory
  gene_output_dir <- paste0(base_output_dir, gene, "/")
  dir.create(gene_output_dir, recursive = TRUE, showWarnings = FALSE)
  
  # Get expression values
  gene_expr <- FetchData(seurat_obj, vars = gene)[,1]
  
  # -------------------------------------------------------------------------
  # VERSION 1: Gray out other stages, show expression for current stage
  # -------------------------------------------------------------------------
  
  stage_plots_list <- list()
  
  for (group in timepoint_groups) {
    # Create temporary expression: 0 for other groups (will be gray), actual values for current group
    temp_expr <- ifelse(seurat_obj$timepoint_group == group, gene_expr, 0)
    
    # Add temporary expression to metadata
    seurat_obj$temp_gene_expr <- temp_expr
    
    # Calculate max cutoff only from current group (avoid NA issues)
    current_group_expr <- gene_expr[seurat_obj$timepoint_group == group]
    max_cutoff <- quantile(current_group_expr, 0.99, na.rm = TRUE)
    
    # Create FeaturePlot for this timepoint
    p_stage <- FeaturePlot(seurat_obj, 
                           features = "temp_gene_expr",
                           reduction = "umap",
                           pt.size = 0.5,
                           order = TRUE,
                           min.cutoff = 0,
                           max.cutoff = max_cutoff) +
      scale_color_gradientn(
        colors = c("lightgrey", "#FEE5D9", "#FCAE91", "#FB6A4A", "#DE2D26", "#A50F15"),
        name = "Expression"
      ) +
      ggtitle(paste(gene, "-", group)) +
      theme_minimal(base_size = 12) +
      theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
            legend.position = "right",
            axis.text = element_blank(),
            axis.title = element_blank(),
            axis.ticks = element_blank(),
            panel.grid = element_blank())
    
    stage_plots_list[[group]] <- p_stage
  }
  
  # -------------------------------------------------------------------------
  # VERSION 2: Stage-specific colors (each timepoint uses its own color)
  # -------------------------------------------------------------------------
  
  stage_plots_colored <- list()
  
  for (group in timepoint_groups) {
    # Get expression only for current group (0 for others)
    temp_expr <- ifelse(seurat_obj$timepoint_group == group, gene_expr, 0)
    seurat_obj$temp_expr_stage <- temp_expr
    
    # Calculate max cutoff for current group
    current_group_expr <- gene_expr[seurat_obj$timepoint_group == group]
    max_cutoff <- quantile(current_group_expr, 0.99, na.rm = TRUE)
    
    # Create color gradient from white to stage color
    stage_gradient <- colorRampPalette(c("gray90", "white", timepoint_colors[group]))(100)
    
    # Create plot with stage-specific color
    p_colored <- FeaturePlot(seurat_obj,
                             features = "temp_expr_stage",
                             reduction = "umap",
                             pt.size = 0.5,
                             order = TRUE,
                             min.cutoff = 0,
                             max.cutoff = max_cutoff) +
      scale_color_gradientn(
        colors = stage_gradient,
        name = "Expression"
      ) +
      ggtitle(paste(gene, "Expression -", group)) +
      theme_minimal(base_size = 12) +
      theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
            legend.position = "right",
            axis.text = element_blank(),
            axis.title = element_blank(),
            axis.ticks = element_blank(),
            panel.grid = element_blank())
    
    stage_plots_colored[[group]] <- p_colored
  }
  
  # -------------------------------------------------------------------------
  # VERSION 3: Binary highlighting (expressing vs non-expressing per stage)
  # -------------------------------------------------------------------------
  
  stage_plots_binary <- list()
  
  for (group in timepoint_groups) {
    # Get expression for current group only
    current_expr <- gene_expr[seurat_obj$timepoint_group == group]
    
    # Calculate threshold for current group (median of expressing cells)
    if(sum(current_expr > 0) > 0) {
      threshold_group <- median(current_expr[current_expr > 0])
    } else {
      threshold_group <- 0
    }
    
    # Create binary status
    seurat_obj$stage_binary <- case_when(
      seurat_obj$timepoint_group != group ~ "Other Stage",
      gene_expr > threshold_group ~ "High Expression",
      gene_expr > 0 ~ "Low Expression",
      TRUE ~ "Not Detected"
    )
    
    seurat_obj$stage_binary <- factor(seurat_obj$stage_binary,
                                       levels = c("Other Stage", "Not Detected", 
                                                 "Low Expression", "High Expression"))
    
    # Create plot
    p_binary <- DimPlot(seurat_obj,
                        reduction = "umap",
                        group.by = "stage_binary",
                        cols = c("Other Stage" = "gray90",
                                "Not Detected" = "gray80",
                                "Low Expression" = "#FFA500",
                                "High Expression" = timepoint_colors[group]),
                        order = c("High Expression", "Low Expression", "Not Detected", "Other Stage"),
                        pt.size = 0.5) +
      ggtitle(paste(gene, "-", group)) +
      theme_minimal(base_size = 12) +
      theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
            legend.position = "right",
            legend.text = element_text(size = 8),
            axis.text = element_blank(),
            axis.title = element_blank(),
            axis.ticks = element_blank(),
            panel.grid = element_blank())
    
    stage_plots_binary[[group]] <- p_binary
  }
  
  # -------------------------------------------------------------------------
  # Create combined panel figures
  # -------------------------------------------------------------------------
  
  # Version 1: Standard expression (grayscale for non-current stage)
  combined_stages <- wrap_plots(stage_plots_list, ncol = 2)
  
  # Version 2: Colored by stage
  combined_stages_colored <- wrap_plots(stage_plots_colored, ncol = 2)
  
  # Version 3: Binary (high vs low vs not detected)
  combined_stages_binary <- wrap_plots(stage_plots_binary, ncol = 2)
  
  # -------------------------------------------------------------------------
  # Calculate expression statistics per stage
  # -------------------------------------------------------------------------
  
  stage_stats <- data.frame()
  
  for (group in timepoint_groups) {
    group_cells <- seurat_obj$timepoint_group == group
    group_expr <- gene_expr[group_cells]
    
    # Calculate mean of expressing cells (excluding zeros)
    if(sum(group_expr > 0) > 0) {
      mean_expressing <- mean(group_expr[group_expr > 0])
    } else {
      mean_expressing <- 0
    }
    
    stats <- data.frame(
      Stage = group,
      N_cells = sum(group_cells),
      Mean_expr = mean(group_expr),
      Median_expr = median(group_expr),
      Pct_expressing = sum(group_expr > 0) / length(group_expr) * 100,
      Mean_of_expressing = mean_expressing,
      Max_expr = max(group_expr)
    )
    
    stage_stats <- rbind(stage_stats, stats)
  }
  
  message("\nExpression statistics for ", gene, " by stage:")
  print(stage_stats)
  
  # -------------------------------------------------------------------------
  # Save everything for this gene
  # -------------------------------------------------------------------------
  
  # Save individual stage plots (optional - uncomment if needed)
  # for (i in 1:length(timepoint_groups)) {
  #   group <- timepoint_groups[i]
  #   filename <- gsub(", ", "_", group)
  #   
  #   ggsave(paste0(gene_output_dir, gene, "_stage_", filename, "_standard.png"), 
  #          stage_plots_list[[i]], width = 8, height = 7, dpi = 300)
  #   
  #   ggsave(paste0(gene_output_dir, gene, "_stage_", filename, "_colored.png"), 
  #          stage_plots_colored[[i]], width = 8, height = 7, dpi = 300)
  #   
  #   ggsave(paste0(gene_output_dir, gene, "_stage_", filename, "_binary.png"), 
  #          stage_plots_binary[[i]], width = 8, height = 7, dpi = 300)
  # }
  
  # Save combined panels
  ggsave(paste0(gene_output_dir, gene, "_all_stages_combined_standard.png"), 
         combined_stages, width = 16, height = 20, dpi = 300)
  
  ggsave(paste0(gene_output_dir, gene, "_all_stages_combined_colored.png"), 
         combined_stages_colored, width = 16, height = 20, dpi = 300)
  
  ggsave(paste0(gene_output_dir, gene, "_all_stages_combined_binary.png"), 
         combined_stages_binary, width = 16, height = 20, dpi = 300)
  
  # Save statistics
  write.csv(stage_stats, paste0(gene_output_dir, gene, "_expression_by_stage.csv"), 
            row.names = FALSE)
  
  message("\nSaved all plots and statistics for ", gene, " to: ", gene_output_dir)
  
} # End of gene loop

message("\n========================================")
message("ALL GENES PROCESSED!")
message("========================================")
```
