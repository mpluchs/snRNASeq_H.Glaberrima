# =============================================================================
# Create Neuronal Subset from Clusters
# =============================================================================

library(Seurat)
library(tidyverse)
library(patchwork)
library(openxlsx)
library(reticulate)

# Import Python libraries
scvi <- import("scvi")
reticulate::py_run_string("import scvi; _ = scvi.__version__")
scanpy <- import("scanpy")

# Load the main Seurat object
message("Loading main Seurat object...")
seurat_obj <- readRDS("/data/matthew/250911_new/seurat/seurat_scvi_processed_251124.rds")

# Function to analyze cluster subset
analyze_subset <- function(seurat_obj,
                          source_resolution = 0.8,
                          target_clusters = NULL,
                          new_resolution = 0.5,
                          output_prefix = "subset",
                          output_dir = "/data/matthew/250911_new/nueronal_251125/") {
  
  # Extract subset of cells from specified clusters
  source_col <- paste0("RNA_snn_res.", source_resolution)
  Idents(seurat_obj) <- source_col
  subset_obj <- subset(seurat_obj, idents = target_clusters)
  subset_obj$original_cluster <- subset_obj@meta.data[[source_col]]
  
  message("Subset: ", ncol(subset_obj), " cells from clusters ", 
          paste(target_clusters, collapse = ", "))
  
  # Join layers for Seurat v5
  if (packageVersion("Seurat") >= "5.0.0") {
    subset_obj <- JoinLayers(subset_obj)
  }
  
  # Extract raw counts
  counts <- LayerData(subset_obj, layer = "counts", assay = "RNA")
  metadata <- subset_obj@meta.data
  
  # Create AnnData object
  adata <- scanpy$AnnData(
    X = t(as.matrix(counts)),
    obs = metadata
  )
  
  # Filter genes
  scanpy$pp$filter_genes(adata, min_cells = as.integer(10))
  
  # Setup and train scVI
  message("Training scVI model on subset...")
  scvi$model$SCVI$setup_anndata(
    adata,
    layer = NULL,
    batch_key = "sample"
  )
  
  model <- scvi$model$SCVI(
    adata,
    n_layers = 2L,
    n_latent = 30L,
    gene_likelihood = "nb"
  )
  
  model$train(
    max_epochs = 400L,
    early_stopping = TRUE,
    early_stopping_patience = 15L,
    plan_kwargs = list(lr = 1e-3)
  )
  
  # Get latent representation
  scvi_embeddings <- model$get_latent_representation()
  rownames(scvi_embeddings) <- colnames(subset_obj)
  colnames(scvi_embeddings) <- paste0("scVI_", 1:ncol(scvi_embeddings))
  
  # Add to Seurat
  subset_obj[["scvi"]] <- CreateDimReducObject(
    embeddings = scvi_embeddings,
    key = "scVI_",
    assay = "RNA"
  )
  
  # Clustering on scVI space
  subset_obj <- FindNeighbors(subset_obj, reduction = "scvi", dims = 1:30, k.param = 20)
  subset_obj <- FindClusters(subset_obj, resolution = new_resolution, algorithm = 1)
  subset_obj <- RunUMAP(subset_obj, reduction = "scvi", dims = 1:30, 
                        n.neighbors = 30, min.dist = 0.3, metric = "cosine", seed.use = 42)
  
  message("Found ", length(unique(subset_obj$seurat_clusters)), " new subclusters")
  
  # Create plots
  p1 <- DimPlot(subset_obj, reduction = "umap", label = TRUE, label.size = 4) +
    ggtitle(paste("UMAP: Subclusters (res", new_resolution, ")")) +
    theme(plot.title = element_text(hjust = 0.5))
  
  p2 <- DimPlot(subset_obj, reduction = "umap", group.by = "sample") +
    ggtitle("UMAP: By Sample") +
    theme(plot.title = element_text(hjust = 0.5))
  
  p3 <- DimPlot(subset_obj, reduction = "umap", group.by = "original_cluster") +
    ggtitle(paste("UMAP: Original Clusters (", paste(target_clusters, collapse = ", "), ")")) +
    theme(plot.title = element_text(hjust = 0.5))
  
  umap_plots <- p1 / p2 / p3
  
  
  # Sample composition plots
  sample_colors <- c("N" = "#2E8B57", "C1a" = "#4169E1", "C2a" = "#20B2AA",
                     "R1a" = "#DC143C", "R2a" = "#FF6347", "R2" = "#FFD700",
                     "R5" = "#FFA500", "R7" = "#FF4500", "R10" = "#8B0000",
                     "R2X" = "#FF8C00", "R7X" = "#FF1493", "R10X" = "#8B008B")
  
  table_data <- table(subset_obj$seurat_clusters, subset_obj$sample)
  
  # Sample composition per cluster (stacked)
  prop_by_cluster <- prop.table(table_data, margin = 1) * 100
  df_stacked <- as.data.frame(as.table(prop_by_cluster))
  colnames(df_stacked) <- c("Cluster", "Sample", "Percentage")
  df_stacked$Cluster <- factor(df_stacked$Cluster, levels = sort(as.numeric(levels(df_stacked$Cluster))))
  
  p4 <- ggplot(df_stacked, aes(x = Cluster, y = Percentage, fill = Sample)) +
    geom_bar(stat = "identity", position = "stack") +
    scale_fill_manual(values = sample_colors) +
    labs(title = "Sample Composition by Cluster", 
         x = "Cluster", y = "Percentage of Cells in Cluster", fill = "Sample",
         subtitle = "Shows what % of each cluster is made up of each sample") +
    theme_minimal(base_size = 12) +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5, size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom") +
    coord_cartesian(ylim = c(0, 100))
  
  # % of each sample in each cluster (dodged)
  prop_by_sample <- prop.table(table_data, margin = 2) * 100
  df_by_sample <- as.data.frame(as.table(prop_by_sample))
  colnames(df_by_sample) <- c("Cluster", "Sample", "Percentage")
  
  p5 <- ggplot(df_by_sample, aes(x = Cluster, y = Percentage, fill = Sample)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.8) +
    scale_fill_manual(values = sample_colors) +
    labs(title = "Percent of Each Sample in Each Cluster", 
         x = "Cluster", y = "% of Sample's Total Cells", fill = "Sample",
         subtitle = "Shows what proportion of each sample's cells are found in each cluster") +
    theme_minimal(base_size = 12) +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5, size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom",
          panel.grid.major.x = element_line(color = "gray90", size = 0.5),
          panel.grid.minor = element_blank()) +
    coord_cartesian(ylim = c(0, max(df_by_sample$Percentage) * 1.1))
  
  composition_plots <- p4 / p5
  
  # Find markers using log-normalized RNA
  DefaultAssay(subset_obj) <- "RNA"
  Idents(subset_obj) <- "seurat_clusters"
  
  message("Finding markers...")
  markers <- FindAllMarkers(subset_obj, only.pos = TRUE, min.pct = 0.25,
                           logfc.threshold = 0.5, test.use = "wilcox")
  
  # Load and merge annotations
  annot_path <- "/data/matthew/250911_new/filtered_mito_title_annotations.tsv"
  if (file.exists(annot_path)) {
    annot <- read.delim(annot_path, header = FALSE, stringsAsFactors = FALSE)
    colnames(annot) <- c("qseqid", "sseqid", "pident", "length", "mismatch",
                        "gapopen", "qstart", "qend", "sstart", "send",
                        "evalue", "bitscore", "description")
    
    annot$gene_id <- str_extract(annot$qseqid, "g\\d+")
    annot$gene_symbol <- str_extract(annot$sseqid, "(?<=\\|)[A-Z0-9]+(?=_)")
    annot$protein_name <- str_remove(annot$description, "^sp\\|[^\\s]+\\s+")
    
    annot_sorted <- annot[order(annot$gene_id, -annot$bitscore), ]
    annot_best <- annot_sorted[!duplicated(annot_sorted$gene_id), ]
    
    markers <- merge(markers, annot_best, by.x = "gene", by.y = "gene_id", all.x = TRUE)
    markers <- markers[, c("cluster", "gene", "p_val", "avg_log2FC", "pct.1", "pct.2",
                          "p_val_adj", "gene_symbol", "protein_name", "pident", 
                          "evalue", "bitscore")]
  }
  
  # Save results
  dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
  
  ggsave(paste0(output_dir, output_prefix, "_umap.png"),
         umap_plots, width = 12, height = 16, dpi = 300)
  
  ggsave(paste0(output_dir, output_prefix, "_composition.png"),
         composition_plots, width = 12, height = 10, dpi = 300)
  
  wb <- createWorkbook()
  for(clust in sort(unique(markers$cluster))) {
    addWorksheet(wb, paste0("Cluster_", clust))
    writeData(wb, paste0("Cluster_", clust), markers[markers$cluster == clust, ])
  }
  saveWorkbook(wb, paste0(output_dir, output_prefix, "_markers.xlsx"), overwrite = TRUE)
  
  saveRDS(subset_obj, paste0(output_dir, output_prefix, "_seurat.rds"))
  
  message("\n=== SUMMARY ===")
  message("Original clusters: ", paste(target_clusters, collapse = ", "))
  message("New subclusters: ", length(unique(subset_obj$seurat_clusters)))
  message("Total cells: ", ncol(subset_obj))
  message("Results saved to: ", output_dir)
  
  print(p1)
  print(p2)
  print(p3)
  print(p4)
  print(p5)
  
  return(list(
    seurat_object = subset_obj,
    umap_plots = umap_plots,
    composition_plots = composition_plots,
    markers = markers
  ))
}

# =============================================================================
# Run analysis for neuronal clusters
# =============================================================================

message("\n=== Creating Neuronal Subset ===\n")

neuronal_result <- analyze_subset(
  seurat_obj = seurat_obj,
  source_resolution = 0.8,
  target_clusters = c("11", "13", "14", "15", "18", "2", "23", "24", 
                      "27", "28", "29", "30", "31", "32", "33", "36", "38", "39"),
  new_resolution = 0.3,
  output_prefix = "neuronal_subset",
  output_dir = "/data/matthew/250911_new/neuronal_251125/"
)

# Extract the Seurat object
neuronal_seurat <- neuronal_result$seurat_object

# Save the neuronal_seurat object
message("\nSaving neuronal_seurat object...")
saveRDS(neuronal_seurat, "/data/matthew/250911_new/seurat/neuronal_seurat_251125.rds")

message("\n=== COMPLETE ===")
message("Neuronal subset object saved to: /data/matthew/250911_new/seurat/neuronal_seurat_251125.rds")
message("Analysis results saved to: /data/matthew/250911_new/neuronal_251125/")

# Display final plots
print(neuronal_result$umap_plots)
print(neuronal_result$composition_plots)
